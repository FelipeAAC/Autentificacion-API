<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Ferretería</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .container { max-width: 900px; }
        .form-section, .action-section, .response-section { margin-bottom: 2rem; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .input-group { position: relative; margin-bottom: 1rem; }
        input[type="text"], input[type="email"], input[type="password"], input[type="tel"] {
            width: 100%;
            padding: 0.75rem;
            padding-right: 3rem; 
            border: 1px solid #D1D5DB; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
        }
        .toggle-password {
            position: absolute;
            top: 0; 
            bottom: 0; 
            right: 0.5rem; 
            margin: auto 0; 
            height: fit-content; 
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            color: #6B7280; 
        }
        .input-group > .toggle-password { /* Ajuste para cuando el label está encima */
            top: calc(1em + 1.25rem); 
        }
        .toggle-password:hover { color: #4B5563; }
        button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary { background-color: #4F46E5; color: white; }
        .btn-primary:hover { background-color: #4338CA; }
        .btn-secondary { background-color: #6B7280; color: white; }
        .btn-secondary:hover { background-color: #4B5563; }
        .btn-danger { background-color: #DC2626; color: white; } /* red-600 */
        .btn-danger:hover { background-color: #B91C1C; } /* red-700 */
        #apiResponse, #storeContent, #userInfo {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #F3F4F6; 
            border-radius: 0.375rem;
            white-space: pre-wrap;
            word-break: break-all;
            min-height: 50px; 
        }
        .token-display { font-family: monospace; background-color: #E5E7EB; padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; display: inline-block; max-width: 100%; overflow-x: auto;}
        .placeholder-text { color: #9CA3AF; } 
        .store-product { border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.5rem; background-color: white;}
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <div class="inline-flex items-center justify-center bg-indigo-600 p-3 rounded-full mb-4 shadow-lg">
                <i class="fas fa-tools fa-2x text-white"></i>
            </div>
            <h1 class="text-4xl font-bold text-indigo-700">Ferretería Online - Test API</h1>
            <p class="text-gray-600 mt-2">Plataforma de prueba para el sistema de autenticación y tienda.</p>
        </header>

        <div class="grid md:grid-cols-2 gap-8">
            <section class="form-section bg-white">
                <h2 class="text-2xl font-semibold mb-6 text-indigo-600 border-b pb-2">Registrar Nuevo Cliente</h2>
                <form id="registerForm">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="regPNombre">Primer Nombre:</label>
                            <input type="text" id="regPNombre" name="p_nombre" required>
                        </div>
                        <div>
                            <label for="regSNombre">Segundo Nombre:</label>
                            <input type="text" id="regSNombre" name="s_nombre">
                        </div>
                        <div>
                            <label for="regPApellido">Primer Apellido:</label>
                            <input type="text" id="regPApellido" name="p_apellido" required>
                        </div>
                        <div>
                            <label for="regSApellido">Segundo Apellido:</label>
                            <input type="text" id="regSApellido" name="s_apellido">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="regTelefono">Teléfono:</label>
                        <input type="tel" id="regTelefono" name="telefono" placeholder="+56912345678">
                    </div>
                    <div class="mb-4">
                        <label for="regCorreo">Correo Electrónico:</label>
                        <input type="email" id="regCorreo" name="correo" required>
                    </div>
                    <div class="input-group mb-4">
                        <label for="regPassword">Contraseña:</label>
                        <input type="password" id="regPassword" name="password" required minlength="8">
                        <button type="button" class="toggle-password" data-target="regPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="input-group mb-6">
                        <label for="regConfirmPassword">Confirmar Contraseña:</label>
                        <input type="password" id="regConfirmPassword" name="confirm_password" required minlength="8">
                        <button type="button" class="toggle-password" data-target="regConfirmPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <button type="submit" class="btn-primary w-full">Registrar</button>
                </form>
            </section>

            <div class="space-y-8">
                <section class="form-section bg-white">
                    <h2 class="text-2xl font-semibold mb-6 text-indigo-600 border-b pb-2">Iniciar Sesión</h2>
                    <form id="loginForm">
                        <div class="mb-4">
                            <label for="loginCorreo">Correo Electrónico:</label>
                            <input type="email" id="loginCorreo" name="username" required>
                        </div>
                        <div class="input-group mb-6">
                            <label for="loginPassword">Contraseña:</label>
                            <input type="password" id="loginPassword" name="password" required>
                            <button type="button" class="toggle-password" data-target="loginPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <button type="submit" class="btn-primary w-full">Iniciar Sesión</button>
                    </form>
                    <div class="mt-6">
                        <strong>Token JWT Actual:</strong> <span id="jwtToken" class="token-display">Ninguno</span>
                    </div>
                </section>

                <section class="action-section bg-white">
                    <h2 class="text-2xl font-semibold mb-6 text-indigo-600 border-b pb-2">Acciones Protegidas</h2>
                    <div class="space-y-4">
                        <button id="getMeBtn" class="btn-secondary w-full">Obtener Mis Datos (/users/me)</button>
                        <button id="getStoreBtn" class="btn-secondary w-full">Acceder a la Tienda (/store)</button>
                        <button id="deleteAccountBtn" class="btn-danger w-full mt-2">Eliminar Mi Cuenta</button>
                    </div>
                    <div id="userInfo" class="hidden mt-4"><p class="placeholder-text">Información del usuario aparecerá aquí...</p></div>
                    <div id="storeContent" class="mt-4"><p class="placeholder-text">Contenido de la tienda aparecerá aquí...</p></div>
                </section>
            </div>
        </div>
        
        <section class="response-section bg-white mt-8">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600 border-b pb-2">Respuesta General de la API</h2>
            <pre id="apiResponse">Aquí se mostrarán las respuestas generales de la API...</pre>
        </section>
    </div>

    <script>
        const API_BASE_URL = "http://127.0.0.1:8002"; 

        const registerForm = document.getElementById('registerForm');
        const loginForm = document.getElementById('loginForm');
        const getMeBtn = document.getElementById('getMeBtn');
        const getStoreBtn = document.getElementById('getStoreBtn');
        const deleteAccountBtn = document.getElementById('deleteAccountBtn');
        const apiResponseEl = document.getElementById('apiResponse');
        const jwtTokenEl = document.getElementById('jwtToken');
        const userInfoEl = document.getElementById('userInfo');
        const storeContentEl = document.getElementById('storeContent');

        function displayResponse(data, element = apiResponseEl, isStoreData = false) {
            if (isStoreData && element === storeContentEl) {
                element.innerHTML = ''; 
                
                const title = document.createElement('h3');
                title.className = 'text-xl font-semibold text-indigo-700 mb-3';
                title.textContent = data.page_title || 'Tienda';
                element.appendChild(title);

                const welcomeMsg = document.createElement('p');
                welcomeMsg.className = 'mb-4 text-gray-700';
                welcomeMsg.textContent = data.welcome_message || 'Bienvenido!';
                element.appendChild(welcomeMsg);

                if (data.categories && data.categories.length > 0) {
                    const catTitle = document.createElement('h4');
                    catTitle.className = 'text-lg font-medium text-gray-800 mb-2';
                    catTitle.textContent = 'Categorías Populares:';
                    element.appendChild(catTitle);
                    const ulCat = document.createElement('ul');
                    ulCat.className = 'list-disc list-inside mb-4 space-y-1';
                    data.categories.forEach(cat => {
                        const li = document.createElement('li');
                        li.className = 'text-gray-600';
                        li.textContent = `${cat.name} (${cat.product_count} productos)`;
                        ulCat.appendChild(li);
                    });
                    element.appendChild(ulCat);
                }

                if (data.featured_products && data.featured_products.length > 0) {
                    const prodTitle = document.createElement('h4');
                    prodTitle.className = 'text-lg font-medium text-gray-800 mb-2';
                    prodTitle.textContent = 'Productos Destacados:';
                    element.appendChild(prodTitle);
                    data.featured_products.forEach(prod => {
                        const prodDiv = document.createElement('div');
                        prodDiv.className = 'store-product';
                        prodDiv.innerHTML = `<p class="font-semibold">${prod.name}</p><p class="text-sm text-indigo-600">${prod.price}</p>`;
                        element.appendChild(prodDiv);
                    });
                }
                element.classList.remove('hidden');

            } else {
                element.textContent = JSON.stringify(data, null, 2);
                element.classList.remove('hidden');
                const placeholder = element.querySelector('.placeholder-text');
                if (placeholder) {
                    placeholder.classList.add('hidden');
                }
            }
        }

        function displayError(error, element = apiResponseEl) {
            element.innerHTML = ''; 
            const errorText = `Error: ${error.message || JSON.stringify(error.detail || error, null, 2)}`;
            element.textContent = errorText;
            element.classList.remove('hidden');
            const placeholder = element.querySelector('.placeholder-text');
            if (placeholder) {
                placeholder.classList.add('hidden');
            }
            console.error("API Error:", error);
        }

        function clearDisplay(element, defaultText = 'Esperando acción...') {
            element.innerHTML = `<p class="placeholder-text">${defaultText}</p>`;
        }

        function logoutUser() {
            localStorage.removeItem('jwtToken');
            jwtTokenEl.textContent = "Sesión cerrada o cuenta eliminada.";
            clearDisplay(userInfoEl, 'Información del usuario aparecerá aquí...'); userInfoEl.classList.add('hidden');
            clearDisplay(storeContentEl, 'Contenido de la tienda aparecerá aquí...'); storeContentEl.classList.add('hidden');
            apiResponseEl.textContent = "Por favor, inicia sesión o regístrate.";
        }


        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(registerForm);
            const data = {};
            formData.forEach((value, key) => {
                if (value.trim() !== '') { 
                    data[key] = value;
                }
            });

            if (!data.password || data.password !== data.confirm_password) { 
                displayError({ message: "Las contraseñas no coinciden o faltan." });
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw result; 
                displayResponse(result);
                registerForm.reset(); 
            } catch (error) {
                displayError(error.detail || error);
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(loginForm);
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/token`, {
                    method: 'POST',
                    body: formData 
                });
                const result = await response.json();
                if (!response.ok) throw result;

                localStorage.setItem('jwtToken', result.access_token);
                jwtTokenEl.textContent = result.access_token;
                displayResponse({ message: "Inicio de sesión exitoso!", token_info: result });
                clearDisplay(userInfoEl, 'Información del usuario aparecerá aquí...'); userInfoEl.classList.add('hidden');
                clearDisplay(storeContentEl, 'Contenido de la tienda aparecerá aquí...'); storeContentEl.classList.remove('hidden'); 
            } catch (error) {
                logoutUser(); 
                displayError(error.detail || error);
            }
        });

        async function fetchProtectedData(endpoint, displayElement) {
            const token = localStorage.getItem('jwtToken');
            displayElement.classList.remove('hidden'); 
            clearDisplay(displayElement, displayElement === userInfoEl ? 'Información del usuario aparecerá aquí...' : 'Cargando tienda...');


            if (!token) {
                displayError({ message: "No hay token JWT. Por favor, inicia sesión." }, displayElement);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 401) { // Específicamente para no autorizado
                    const errorResult = await response.json(); // Intentar parsear el error de la API
                    throw { status: 401, detail: errorResult.detail || "Token inválido o expirado." };
                }
                if (!response.ok) { // Para otros errores HTTP
                     const errorResult = await response.json();
                     throw { status: response.status, detail: errorResult.detail || `Error HTTP ${response.status}` };
                }

                const result = await response.json();
                
                if (endpoint === '/store') {
                    displayResponse(result, displayElement, true); 
                } else {
                    displayResponse(result, displayElement);
                }

            } catch (error) {
                displayError(error, displayElement); // error ya debería tener detail o message
                 if (error.status === 401) {
                    logoutUser();
                }
            }
        }

        getMeBtn.addEventListener('click', () => {
            clearDisplay(storeContentEl, 'Contenido de la tienda aparecerá aquí...'); storeContentEl.classList.add('hidden');
            fetchProtectedData('/users/me', userInfoEl);
        });
        getStoreBtn.addEventListener('click', () => {
            clearDisplay(userInfoEl, 'Información del usuario aparecerá aquí...'); userInfoEl.classList.add('hidden');
            fetchProtectedData('/store', storeContentEl);
        });
        
        deleteAccountBtn.addEventListener('click', async () => {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                displayError({ message: "No has iniciado sesión. No se puede eliminar la cuenta." });
                return;
            }

            if (confirm("¿Estás seguro de que quieres eliminar tu cuenta? Esta acción no se puede deshacer.")) {
                try {
                    const response = await fetch(`${API_BASE_URL}/users/me`, { 
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.status === 204) { 
                        displayResponse({ message: "Cuenta eliminada exitosamente." });
                        logoutUser();
                    } else if (response.status === 401) {
                        const errorResult = await response.json();
                        throw { status: 401, detail: errorResult.detail || "No autorizado o token expirado." };
                    }
                    else {
                        const errorResult = await response.json();
                        throw errorResult;
                    }
                } catch (error) {
                    displayError(error.detail || error);
                     if (error.status === 401) {
                        logoutUser();
                    }
                }
            }
        });


        const storedToken = localStorage.getItem('jwtToken');
        if (storedToken) {
            jwtTokenEl.textContent = storedToken;
        }
        clearDisplay(userInfoEl, 'Información del usuario aparecerá aquí...'); userInfoEl.classList.add('hidden');
        clearDisplay(storeContentEl, 'Contenido de la tienda aparecerá aquí...');


        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.dataset.target;
                const passwordInput = document.getElementById(targetId);
                const icon = this.querySelector('i');

                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        });
    </script>
</body>
</html>